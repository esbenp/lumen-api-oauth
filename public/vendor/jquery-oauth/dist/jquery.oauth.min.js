!function(t,e){"function"==typeof define&&define.amd?define(["jquery","store"],e):"object"==typeof exports?module.exports=e(require("jquery"),require("store")):t.jqOAuth=e(t.jQuery,t.store)}(this,function(t,e){var r=function(e){this.options={},this.data={},this.intercept=!1,this.refreshing=!1,this.buffer=[],this.currentRequests=[],this._resetOptions(),this._setupInterceptor(),t.extend(this.options,e),this._hasStoredData()?(this._getStoredData(),this.hasAccessToken()&&this.login(this.data.accessToken)):(this._resetData(),this._updateStorage()),null!==e.csrfToken&&this._setCsrfHeader()};return r.prototype.getAccessToken=function(){return this.data.accessToken},r.prototype.hasAccessToken=function(){return null!==this.data.accessToken},r.prototype.logout=function(){this._resetData(),this._updateStorage(),this._deactivateInterceptor(),this._removeAjaxHeader("Authorization"),this._fireEvent("logout")},r.prototype.login=function(t){this.setAccessToken(t),this._activateInterceptor(),this._fireEvent("login")},r.prototype.setAccessToken=function(t){this.data.accessToken=t,this._setAuthorizationHeader(),this._updateStorage()},r.prototype.setCsrfToken=function(t){this.options.csrfToken=t,this._setCsrfHeader()},r.prototype._activateInterceptor=function(){this.intercept=!0},r.prototype._addToBuffer=function(t,e){this.buffer.push({deferred:e,settings:t})},r.prototype._clearBuffer=function(){this.buffer=[]},r.prototype._deactivateInterceptor=function(){this.intercept=!1},r.prototype._fireBuffer=function(){var e,r=this,o=[];for(var i in this.buffer)e=this.buffer[i].deferred,this.buffer[i].settings.refreshRetry=!0,this.buffer[i].settings.headers.Authorization=t.ajaxSettings.headers.Authorization,o.push(t.ajax(this.buffer[i].settings).then(e.resolve,e.reject));this._clearBuffer(),t.when.apply(t,o).done(function(){r._setRefreshingFlag(!1)}).fail(function(){r._setRefreshingFlag(!1),this.logout()})},r.prototype._fireEvent=function(t){return this._hasEvent(t)?this.options.events[t]():void 0},r.prototype._getStoredData=function(){t.extend(this.data,e.get(this.options.tokenName))},r.prototype._hasEvent=function(t){return void 0!==this.options.events[t]&&"function"==typeof this.options.events[t]},r.prototype._hasStoredData=function(){return void 0!==e.get(this.options.tokenName)},r.prototype._isAjaxHeadersInitialized=function(){return void 0!==t.ajaxSettings.headers},r.prototype._removeAjaxHeader=function(e){return this._isAjaxHeadersInitialized()?void(t.ajaxSettings.headers[e]=void 0):!0},r.prototype._removeAllAjaxHeaders=function(){this._removeAjaxHeader("Authorization"),this._removeAjaxHeader("X-CSRF-Token")},r.prototype._resetData=function(){this.data={accessToken:null}},r.prototype._resetOptions=function(){this.options={bufferInterval:25,bufferWaitLimit:500,csrfToken:null,events:{},tokenName:"jquery.oauth"},this._removeAllAjaxHeaders()},r.prototype._setAjaxHeader=function(e,r){this._isAjaxHeadersInitialized()||(t.ajaxSettings.headers={}),t.ajaxSettings.headers[e]=r},r.prototype._setAuthorizationHeader=function(){this._setAjaxHeader("Authorization","Bearer "+this.data.accessToken)},r.prototype._setCsrfHeader=function(){this._setAjaxHeader("X-CSRF-Token",this.options.csrfToken)},r.prototype._setRefreshingFlag=function(t){this.refreshing=t},r.prototype._setupInterceptor=function(){var e=this;t.ajaxPrefilter(function(r,o,i){if(r.refreshRetry!==!0){var s=t.Deferred();return e.currentRequests.push(r.url),i.always(function(){e.currentRequests.splice(t.inArray(r.url,e.currentRequests),1)}),i.done(s.resolve),i.fail(function(){var t=Array.prototype.slice.call(arguments);e.intercept&&401===i.status&&e._hasEvent("tokenExpiration")?(e._addToBuffer(r,s),e.refreshing||(e._setRefreshingFlag(!0),e._fireEvent("tokenExpiration").success(function(){{var t=0;setInterval(function(){t+=e.options.bufferInterval,(0===e.currentRequests.length||t>=e.options.bufferWaitLimit)&&(clearInterval(e.interval),e._fireBuffer())},e.options.bufferInterval)}}).fail(function(){e.logout()}))):s.rejectWith(i,t)}),s.promise(i)}})},r.prototype._updateStorage=function(){e.set(this.options.tokenName,this.data)},r});